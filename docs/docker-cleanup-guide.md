# Docker åƒåœ¾æ¸…ç†æŒ‡å—

æœ¬æ–‡æ¡£æä¾›äº†æ¸…ç† FoomClous é¡¹ç›® Docker åƒåœ¾æ–‡ä»¶çš„è¯¦ç»†æŒ‡å—ã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿæ¸…ç†](#å¿«é€Ÿæ¸…ç†)
- [åˆ†æ­¥æ¸…ç†](#åˆ†æ­¥æ¸…ç†)
- [æ¸…ç†è¯´æ˜](#æ¸…ç†è¯´æ˜)
- [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

---

## ğŸš€ å¿«é€Ÿæ¸…ç†

### æ–¹æ³• 1ï¼šä½¿ç”¨æ¸…ç†è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
chmod +x docker-cleanup.sh

# 2. è¿è¡Œæ¸…ç†è„šæœ¬
./docker-cleanup.sh
```

### æ–¹æ³• 2ï¼šä¸€é”®æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨èµ„æº

```bash
# âš ï¸ è­¦å‘Šï¼šè¿™ä¼šåˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å®¹å™¨ã€é•œåƒã€ç½‘ç»œå’Œå·
docker system prune -a --volumes -f
```

---

## ğŸ”§ åˆ†æ­¥æ¸…ç†

### 1. åœæ­¢å¹¶åˆ é™¤å®¹å™¨

```bash
# åœæ­¢å¹¶åˆ é™¤ docker-compose ç®¡ç†çš„å®¹å™¨
docker-compose down

# åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨
docker container prune -f
```

### 2. æ¸…ç†é•œåƒ

```bash
# æŸ¥çœ‹æ‰€æœ‰é•œåƒ
docker images

# åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a -f

# åˆ é™¤ç‰¹å®šé•œåƒï¼ˆå¯é€‰ï¼‰
docker rmi <é•œåƒID>
```

### 3. æ¸…ç†å·

```bash
# æŸ¥çœ‹æ‰€æœ‰å·
docker volume ls

# åˆ é™¤æœªä½¿ç”¨çš„å·ï¼ˆâš ï¸ ä¼šåˆ é™¤æ•°æ®ï¼ï¼‰
docker volume prune -f

# åˆ é™¤ç‰¹å®šå·ï¼ˆå¯é€‰ï¼‰
docker volume rm <å·å>
```

### 4. æ¸…ç†ç½‘ç»œ

```bash
# æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œ
docker network ls

# åˆ é™¤æœªä½¿ç”¨çš„ç½‘ç»œ
docker network prune -f
```

### 5. æ¸…ç†æ„å»ºç¼“å­˜

```bash
# åˆ é™¤æ‰€æœ‰æ„å»ºç¼“å­˜
docker builder prune -a -f
```

---

## ğŸ“Š æ¸…ç†è¯´æ˜

### å„ç±»èµ„æºè¯´æ˜

| èµ„æºç±»å‹ | è¯´æ˜ | æ˜¯å¦åˆ é™¤æ•°æ® |
|---------|------|------------|
| **å®¹å™¨** | è¿è¡Œä¸­çš„åº”ç”¨å®ä¾‹ | âŒ å¦ |
| **é•œåƒ** | æ„å»ºçš„åº”ç”¨é•œåƒ | âŒ å¦ |
| **å·** | æŒä¹…åŒ–æ•°æ®å­˜å‚¨ | âš ï¸ **æ˜¯** |
| **ç½‘ç»œ** | å®¹å™¨é—´é€šä¿¡ç½‘ç»œ | âŒ å¦ |
| **æ„å»ºç¼“å­˜** | Docker æ„å»ºæ—¶çš„ç¼“å­˜å±‚ | âŒ å¦ |

### æœ¬é¡¹ç›®ä½¿ç”¨çš„å·

æ ¹æ® `docker-compose.yml`ï¼Œæœ¬é¡¹ç›®ä½¿ç”¨ä»¥ä¸‹å·ï¼š

- **`file-storage`**: å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶ã€ç¼©ç•¥å›¾å’Œåˆ†å—æ•°æ®
  - `/data/uploads` - ä¸Šä¼ çš„æ–‡ä»¶
  - `/data/thumbnails` - ç¼©ç•¥å›¾
  - `/data/chunks` - åˆ†å—æ•°æ®

- **`postgres-data`**: PostgreSQL æ•°æ®åº“æ•°æ®
  - `/var/lib/postgresql/data` - æ•°æ®åº“æ–‡ä»¶

âš ï¸ **è­¦å‘Š**ï¼šåˆ é™¤è¿™äº›å·ä¼šå¯¼è‡´æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶å’Œæ•°æ®åº“æ•°æ®ä¸¢å¤±ï¼

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®å¤‡ä»½

åœ¨æ¸…ç†å·ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½é‡è¦æ•°æ®ï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
docker-compose exec postgres pg_dump -U foomclous foomclous > backup.sql

# å¤‡ä»½æ–‡ä»¶å­˜å‚¨ï¼ˆåœ¨å®¿ä¸»æœºä¸Šï¼‰
docker run --rm -v foomclous_file-storage:/data -v $(pwd):/backup alpine tar czf /backup/file-storage-backup.tar.gz /data
```

### 2. ä¿ç•™ç‰¹å®šå·

å¦‚æœåªæƒ³æ¸…ç†é•œåƒå’Œç¼“å­˜ï¼Œè€Œä¸åˆ é™¤æ•°æ®å·ï¼š

```bash
# ä¸ä½¿ç”¨ --volumes å‚æ•°
docker system prune -a -f
```

### 3. æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ

æ¸…ç†å‰åå¯ä»¥æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š

```bash
# æŸ¥çœ‹ Docker ç£ç›˜ä½¿ç”¨
docker system df

# è¯¦ç»†ä¿¡æ¯
docker system df -v
```

### 4. é‡æ–°å¯åŠ¨é¡¹ç›®

æ¸…ç†åé‡æ–°å¯åŠ¨é¡¹ç›®ï¼š

```bash
# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# æˆ–è€…åªå¯åŠ¨ï¼ˆå¦‚æœé•œåƒè¿˜åœ¨ï¼‰
docker-compose up -d
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: æ¸…ç†åé¡¹ç›®æ— æ³•å¯åŠ¨ï¼Ÿ

**A**: å¦‚æœåˆ é™¤äº†é•œåƒï¼Œéœ€è¦é‡æ–°æ„å»ºï¼š

```bash
docker-compose up -d --build
```

### Q2: æ•°æ®ä¸¢å¤±äº†æ€ä¹ˆåŠï¼Ÿ

**A**: å¦‚æœè¯¯åˆ äº†å·ï¼Œåªèƒ½ä»å¤‡ä»½æ¢å¤ï¼š

```bash
# æ¢å¤æ•°æ®åº“
docker-compose exec -T postgres psql -U foomclous foomclous < backup.sql

# æ¢å¤æ–‡ä»¶å­˜å‚¨
docker run --rm -v foomclous_file-storage:/data -v $(pwd):/backup alpine tar xzf /backup/file-storage-backup.tar.gz -C /
```

### Q3: å¦‚ä½•åªæ¸…ç†ç‰¹å®šé¡¹ç›®çš„èµ„æºï¼Ÿ

**A**: ä½¿ç”¨ docker-compose å‘½ä»¤ï¼š

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ã€ç½‘ç»œï¼ˆä¿ç•™å·ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ã€ç½‘ç»œã€å·ï¼ˆâš ï¸ åˆ é™¤æ•°æ®ï¼‰
docker-compose down -v

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ã€ç½‘ç»œã€å·ã€é•œåƒ
docker-compose down -v --rmi all
```

### Q4: ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¦‚ä½•å¿«é€Ÿé‡Šæ”¾ï¼Ÿ

**A**: æŒ‰ä¼˜å…ˆçº§æ¸…ç†ï¼š

```bash
# 1. å…ˆæ¸…ç†æ„å»ºç¼“å­˜ï¼ˆé€šå¸¸å ç”¨æœ€å¤šï¼‰
docker builder prune -a -f

# 2. æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a -f

# 3. æ¸…ç†åœæ­¢çš„å®¹å™¨
docker container prune -f

# 4. æœ€åè€ƒè™‘æ¸…ç†å·ï¼ˆä¼šåˆ é™¤æ•°æ®ï¼‰
docker volume prune -f
```

---

## ğŸ“ˆ ç›‘æ§ç£ç›˜ä½¿ç”¨

å®šæœŸæ£€æŸ¥ Docker ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š

```bash
# ç®€å•æŸ¥çœ‹
docker system df

# è¯¦ç»†æŸ¥çœ‹
docker system df -v

# æŸ¥çœ‹ç‰¹å®šç±»å‹
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
docker volume ls --format "table {{.Name}}\t{{.Driver}}\t{{.Mountpoint}}"
```

---

## ğŸ›¡ï¸ æœ€ä½³å®è·µ

1. **å®šæœŸæ¸…ç†**ï¼šå»ºè®®æ¯æœˆæ¸…ç†ä¸€æ¬¡æ„å»ºç¼“å­˜å’Œæœªä½¿ç”¨çš„é•œåƒ
2. **å¤‡ä»½æ•°æ®**ï¼šæ¸…ç†å·ä¹‹å‰åŠ¡å¿…å¤‡ä»½æ•°æ®
3. **ç›‘æ§ç£ç›˜**ï¼šå®šæœŸæ£€æŸ¥ Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ
4. **ä½¿ç”¨ .dockerignore**ï¼šå‡å°‘æ„å»ºä¸Šä¸‹æ–‡å¤§å°
5. **å¤šé˜¶æ®µæ„å»º**ï¼šä¼˜åŒ–é•œåƒå¤§å°

---

## ğŸ“š ç›¸å…³å‘½ä»¤å‚è€ƒ

```bash
# æŸ¥çœ‹å¸®åŠ©
docker system --help
docker image --help
docker volume --help
docker container --help

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
docker inspect <å®¹å™¨/é•œåƒ/å·>

# å®æ—¶ç›‘æ§
docker stats
```
