# 上传架构

## 当前流程：服务器中转上传（代理模式）

目前，FoomClous 对 OneDrive 使用 **服务器中转** 的上传策略。

**流程：**
1.  **客户端 -> 服务器**：前端上传组件将文件发送到后端服务器（`/api/upload` 接口）。
2.  **服务器缓存**：后端服务器接收文件并将其保存到临时目录（`/data/temp`）。
3.  **服务器 -> OneDrive**：存储服务 (`OneDriveStorageProvider`) 读取临时文件，并使用 Microsoft Graph API 将其实际上传到 OneDrive。
4.  **清理**：上传成功后，服务器会从本地磁盘删除该临时文件。

**优点：**
*   **安全性**：敏感凭据（客户端密钥、刷新令牌）安全地保留在服务器上，永远不会暴露给客户端。
*   **可控性**：服务器可以在上传前后进行校验、日志记录、缩略图生成等处理。
*   **简洁性**：前端逻辑简单且统一（无论使用哪种存储提供商，都始终上传到同一个后端接口）。

**缺点：**
*   **带宽**：双倍带宽消耗（客户端 -> 服务器，然后服务器 -> OneDrive）。
*   **延迟**：由于经过两跳，上传时间会更长。
*   **服务器负载**：大量上传会消耗服务器的 CPU、内存和磁盘 I/O。

## 替代方案：直接上传（客户端模式）

技术上是可以实现 **直接上传** 的，但这需要对架构进行重大调整：
1.  **请求会话**：前端向后端请求“上传会话”。
2.  **生成 URL**：后端调用 OneDrive API 创建 `uploadUrl`，并将此 URL 返回给前端。
3.  **直接上传**：前端直接向 OneDrive 的 `uploadUrl` 执行 `PUT` 请求。
4.  **完成**：前端通知后端上传已完成，以便后端在数据库中记录文件元数据。

*注意：当前的实现严格使用服务器中转流程。*
